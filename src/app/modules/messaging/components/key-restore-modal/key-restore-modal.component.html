<ion-header>
  <ion-toolbar>
    <ion-title>Restore Encryption Keys</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <form [formGroup]="restoreForm" (ngSubmit)="restore()">
    <ion-text color="medium">
      <p>
        We found encrypted message keys backed up for your account. To access
        your encrypted messages on this device, enter your
        {{ authMethod === "password" ? "password" : "passphrase" }}.
      </p>
      <p>
        <ion-text color="primary">
          <small>{{ helpText }}</small>
        </ion-text>
      </p>
    </ion-text>

    <!-- Lockout Warning -->
    <ion-card *ngIf="isLocked" color="danger">
      <ion-card-content>
        <ion-icon name="lock-closed" size="large"></ion-icon>
        <p>Too many failed attempts. Please try again in 5 minutes.</p>
      </ion-card-content>
    </ion-card>

    <!-- Password/Passphrase Input -->
    <ion-item [disabled]="isLocked">
      <ion-label position="stacked">{{ passwordLabel }} *</ion-label>
      <ion-input
        formControlName="password"
        [type]="showPassword ? 'text' : 'password'"
        [placeholder]="passwordPlaceholder"
        [clearInput]="true"
      ></ion-input>
      <ion-button
        slot="end"
        fill="clear"
        (click)="togglePasswordVisibility()"
        [disabled]="isLocked"
      >
        <ion-icon
          [name]="showPassword ? 'eye-off' : 'eye'"
          slot="icon-only"
        ></ion-icon>
      </ion-button>
    </ion-item>

    <!-- Validation Errors -->
    <ion-text
      color="danger"
      *ngIf="
        restoreForm.get('password')?.invalid &&
        restoreForm.get('password')?.touched
      "
    >
      <small *ngIf="restoreForm.get('password')?.hasError('required')">
        {{ passwordLabel }} is required
      </small>
    </ion-text>

    <!-- Attempt Counter -->
    <ion-text color="warning" *ngIf="attemptCount > 0 && !isLocked">
      <small>
        {{ maxAttempts - attemptCount }} attempt(s) remaining before lockout
      </small>
    </ion-text>

    <!-- Actions -->
    <div class="ion-margin-top">
      <ion-button
        expand="block"
        type="submit"
        [disabled]="!restoreForm.valid || isLoading || isLocked"
      >
        <ion-spinner *ngIf="isLoading" slot="start"></ion-spinner>
        {{ isLoading ? "Restoring..." : "Restore Keys" }}
      </ion-button>

      <ion-button
        expand="block"
        fill="outline"
        color="medium"
        (click)="generateNewKeys()"
        [disabled]="isLoading || isLocked"
      >
        Generate New Keys
      </ion-button>

      <ion-text color="medium" class="ion-text-center">
        <small>
          <p>
            <strong>Note:</strong> Generating new keys will prevent you from
            reading previous encrypted messages.
          </p>
        </small>
      </ion-text>
    </div>

    <!-- Help Section -->
    <ion-card color="light" class="ion-margin-top">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="information-circle"></ion-icon>
          Need Help?
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p *ngIf="authMethod === 'password'">
          If you've forgotten your account password, you can reset it through
          the login page. After resetting, you'll need to update your key
          backup.
        </p>
        <p *ngIf="authMethod === 'sso'">
          If you've forgotten your encryption passphrase, unfortunately there is
          no way to recover it. You'll need to generate new keys.
        </p>
      </ion-card-content>
    </ion-card>
  </form>
</ion-content>
